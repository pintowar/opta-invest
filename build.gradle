plugins {
    id "com.palantir.docker" version "0.22.0"
    id "com.palantir.docker-run" version "0.22.0"
}

version '0.7.0'
group 'com.github.pintowar'

ext {
    vLombokVersion = '1.18.4'
    vOptaPlanner = '7.41.0.Final'
    vReactor = '3.3.8.RELEASE'
}

subprojects {
    version project.version
    group project.group

    apply plugin: 'idea'

    repositories {
        mavenLocal()
        maven { url "https://repo.grails.org/grails/core" }
        mavenCentral()
    }
}

ext {
    jarFileName = 'app.jar'
}

task copyClientResources(dependsOn: ':web-client:build') {
    group = 'build'
    description = 'Copy client resources into server'
    doLast {
        copy {
            from project(':web-client').buildDir.absolutePath
            into "${project(':web-server-boot').buildDir}/resources/main/public"
            into "${project(':web-server-quarkus').buildDir}/resources/main/META-INF/resources"
        }
    }
}

task assembleBootServerAndClient(dependsOn: ['copyClientResources', ':web-server-boot:assemble']) {
    group = 'build'
    description = 'Build combined server & client JAR'

    doLast {
        copy {
            from fileTree(dir: "${project(':web-server-boot').buildDir}/libs/")
            into "$rootDir/build/"
            logger.quiet "JAR generated at $rootDir/build/. It combines the server and client projects."
        }
    }
}

task assembleQuarkusServerAndClient(dependsOn: ['copyClientResources', ':web-server-quarkus:quarkusBuildUber']) {
    group = 'build'
    description = 'Build combined server & client JAR'

    doLast {
        copy {
            from(project(':web-server-quarkus').buildDir) {
                include '*.jar'
            }
            into "$rootDir/build/"
            logger.quiet "JAR generated at $rootDir/build/. It combines the server and client projects."
        }
    }
}

task clean(type: Delete) {
    group = 'build'
    description = 'Clean the client bundle'
    delete 'build'
}

tasks.getByPath(":web-server-boot:assemble").mustRunAfter(copyClientResources)
tasks.getByPath(":web-server-quarkus:assemble").mustRunAfter(copyClientResources)

docker {
    name "pintowar/${project.name}:$version"
    tag 'current', "pintowar/${project.name}:$version"
    tag 'latest', "pintowar/${project.name}:latest"
    dependsOn tasks.assembleBootServerAndClient
    files "$rootDir/build/$jarFileName"
}

dockerRun {
    name 'opta_invest'
    image "pintowar/${project.name}:$version"
    ports '8080'
    clean true
    daemonize true
}
